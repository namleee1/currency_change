# -*- coding: utf-8 -*-
"""currency conversion prediction1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19HYS-l93R0YY2L2LD58ZGeczM5jZGP3S
"""

!pip install statsmodels
!pip install matplotlib
!pip install pandas
!pip install numpy

from google.colab import files
uploaded = files.upload()

import numpy as np
import pandas as pd
from matplotlib import pyplot as plt
import seaborn as sn
import requests
from bs4 import BeautifulSoup
import json
import os
#Bieu dien cac sheet trong file excel
file_path = "/content/Data system POC_11Nov2024(mod) (2).xlsx"
df = pd.read_excel(file_path, sheet_name="Data- refinitiv")

df.isna().sum()

df.duplicated()

df=df.fillna(method='ffill')

df.tail(10)

import matplotlib.pyplot as plt
plt.plot(df['Date'],df['VND'])
plt.xlabel('Date')
plt.ylabel('VND= (BID)')
plt.title('changing of currency conversion after years')
plt.show()

plt.plot(df['Date'],df['FEDRATE'])
plt.xlabel('Date')
plt.ylabel('FED RATE')
plt.title('FED RATE changes after years')
plt.show()

plt.plot(df['Date'],df['DXY'])
plt.xlabel('Date')
plt.ylabel('DXY')
plt.title('DXY changes after years')
plt.show()

plt.plot(df['Date'],df['OMOrate'])
plt.xlabel('Date')
plt.ylabel('OMO rate')
plt.title('OMO rate changes after years')
plt.figure(figsize=(40,4))
plt.show()

plt.plot(df['Date'],df['SBVcentralrate'])
plt.xlabel('Date')
plt.ylabel('SBV central rate')
plt.title('SBV central rate change after years')
plt.figure(figsize=(40,4))
plt.show()

name=input("M·ªùi nh·∫≠p t√™n ch·ªâ s·ªë mu·ªën xem d·ªØ li·ªáu l·ªãch s·ª≠:(FEDRATE,DXY,VND,OMOrate,SBVcentralrate)")
n=int(input("M·ªùi nh·∫≠p s·ªë ng√†y mu·ªën xem:"))
file_path = "/content/Data system POC_11Nov2024(mod).xlsx"
df = pd.read_excel(file_path, sheet_name=None)  # ƒê·ªçc t·∫•t c·∫£ sheet
df_ref = df["Data- refinitiv"]
if name== 'FEDRATE' :
    print(df_ref['Date'].iloc[:n],df_ref['FEDRATE'].iloc[:n], sep='\n') # Print each value on a new line
elif name=='DXY' :
   print(df_ref['Date'].iloc[:n],df_ref['DXY'].iloc[:n], sep='\n') # Change here: Use df_ref to access the column
elif name=='VND' :
   print(df_ref['Date'].iloc[:n],df_ref['VND'].iloc[:n], sep='\n') # Change here: Use df_ref to access the column
elif name=='OMOrate' :
   print(df_ref['Date'].iloc[:n],df_ref['OMOrate'].iloc[:n], sep='\n') # Change here: Use df_ref to access the column
elif name=='SBVcentralrate' :
   print(df_ref['Date'].iloc[:n],df_ref['SBVcentralrate'].iloc[:n], sep='\n') # Change here: Use df_ref to access the column

import pandas as pd
import numpy as np
from statsmodels.tsa.statespace.sarimax import SARIMAX
import matplotlib.pyplot as plt

def train_sarima(df_ref, n):

    # ƒê·∫£m b·∫£o d·ªØ li·ªáu s·∫Øp x·∫øp theo ng√†y
    train_values = df_ref["VND"].dropna().astype(float).sort_index()
    history = list(train_values)

    predictions = []
    labels = []
    percent_changes = []

    for _ in range(n):
        model = SARIMAX(history, order=(2,1,0))
        model_fit = model.fit(disp=False)

        forecast = model_fit.forecast(steps=1)[0]
        prev_value = history[-1]

        trend = "Up" if forecast > prev_value else "Down"
        labels.append(trend)

        percent_change = ((forecast - prev_value) / prev_value * 100) if prev_value != 0 else 0
        percent_changes.append(percent_change)

        history.append(forecast)
        predictions.append(forecast)

    return predictions, labels, percent_changes

# ƒê·ªçc d·ªØ li·ªáu t·ª´ file Excel (ch·ªâ ƒë·ªçc 1 l·∫ßn)
file_path = "/content/Data system POC_11Nov2024(mod) (2).xlsx"
df = pd.read_excel(file_path, sheet_name=None)  # ƒê·ªçc t·∫•t c·∫£ sheet
df_ref = df["Data- refinitiv"]
df1 = df["Sheet2"]
df_ref["Date"] = pd.to_datetime(df_ref["Date"])
df_ref.set_index("Date", inplace=True)

df1["Date"] = pd.to_datetime(df1["Date"])
df1.set_index("Date", inplace=True)

# Ng∆∞·ªùi d√πng nh·∫≠p s·ªë ng√†y c·∫ßn d·ª± b√°o
n = int(input("Nh·∫≠p s·ªë ng√†y c·∫ßn d·ª± b√°o: "))

# Ch·∫°y m√¥ h√¨nh SARIMA
predictions, labels, percent_changes = train_sarima(df_ref, n)

# Xu·∫•t k·∫øt qu·∫£
print("\nüìä **D·ª± b√°o gi√° tr·ªã VND:**", predictions)
print("\nüìà **Xu h∆∞·ªõng bi·∫øn ƒë·ªông:**", labels)
print("\nüìâ **T·ª∑ l·ªá thay ƒë·ªïi (%):**", percent_changes)

# L·∫•y gi√° tr·ªã th·ª±c t·∫ø ƒë·ªÉ so s√°nh
df1["VND"] = df1["VND"].apply(lambda x: float(str(x).replace("\xa0", "")))
Y_TRUE = df1["VND"].iloc[:n].tolist()
print("\n**Gi√° tr·ªã th·ª±c t·∫ø:**", Y_TRUE)
# X√°c ƒë·ªãnh ng√†y b·∫Øt ƒë·∫ßu d·ª± b√°o
last_date = df_ref.index[0]  # Ng√†y cu·ªëi c·ªßa t·∫≠p d·ªØ li·ªáu hu·∫•n luy·ªán
forecast_dates = pd.date_range(start=last_date, periods=n+1, freq='D')[1:]

# **V·∫º BI·ªÇU ƒê·ªí GI√Å L·ªäCH S·ª¨ + D·ª∞ B√ÅO + GI√Å TH·∫¨T**
plt.figure(figsize=(14, 6))

#  **V·∫Ω ƒë∆∞·ªùng gi√° d·ª± b√°o**
plt.plot(forecast_dates, predictions, color='black', linestyle='-', marker='o', label="D·ª± b√°o")

# **V·∫Ω ƒë∆∞·ªùng gi√° th·∫≠t**
plt.plot(forecast_dates, Y_TRUE, color='red', linestyle='--', marker='x', label="Gi√° th·∫≠t")

plt.xlabel("Ng√†y")
plt.ylabel("Gi√° VND")
plt.title("Bi·ªÉu ƒë·ªì gi√° VND - L·ªãch s·ª≠ vs D·ª± b√°o vs Th·ª±c t·∫ø")
plt.legend()
plt.grid(True)
plt.show()

Y_TRUE = np.array(df1["VND"].iloc[:n])
y_pred = np.array(predictions)

# T√≠nh to√°n MSE
from sklearn.metrics import mean_squared_error
import numpy as np

# Import the function to calculate correlation
from scipy.stats import pearsonr

# Calculate the Pearson correlation coefficient
corr, _ = pearsonr(Y_TRUE, y_pred) # pearsonr returns the correlation and the p-value, we only need the correlation
print("H·ªá s·ªë t∆∞∆°ng quan:", corr)

mse = mean_squared_error(Y_TRUE, y_pred)
print("MSE:", mse)

!pip install smtplib
!pip install pandas
!pip install numpy
!pip install matplotlib
!pip install os

import smtplib
import pandas as pd
import numpy as np
import os  # D√πng ƒë·ªÉ l·∫•y bi·∫øn m√¥i tr∆∞·ªùng
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from datetime import datetime, timedelta

# üîπ Nh·∫≠p email ng∆∞·ªùi nh·∫≠n
EMAIL_RECEIVER = input('M·ªùi b·∫°n nh·∫≠p v√†o email ng∆∞·ªùi nh·∫≠n: ')

# üîπ L·∫•y m·∫≠t kh·∫©u t·ª´ bi·∫øn m√¥i tr∆∞·ªùng (Kh√¥ng l∆∞u tr·ª±c ti·∫øp trong code)
EMAIL_SENDER = "namltmta@gmail.com"
EMAIL_PASSWORD = "jlxk sqlk gckc eqzz"

# üîπ Gi·∫£ l·∫≠p d·ª± b√°o t·ª∑ gi√° (d·ªØ li·ªáu m·∫´u)
forecast_dates = forecast_dates
predictions = predictions

# üîπ T·∫°o n·ªôi dung email
email_content = "<h2>D·ª± b√°o t·ª∑ gi√° VND-USD tu·∫ßn t·ªõi</h2><table border='1' cellpadding='5'>"
email_content += "<tr><th>Ng√†y</th><th>D·ª± ƒëo√°n gi√°</th></tr>"

for date, price in zip(forecast_dates, predictions):
    email_content += f"<tr><td>{date.strftime('%Y-%m-%d')}</td><td>{price:.2f} USD</td></tr>"

email_content += "</table>"

# üîπ Thi·∫øt l·∫≠p email
msg = MIMEMultipart()
msg['From'] = EMAIL_SENDER
msg['To'] = EMAIL_RECEIVER
msg['Subject'] = "B√°o c√°o d·ª± b√°o t·ª∑ gi√° VND-USD tu·∫ßn t·ªõi"
msg.attach(MIMEText(email_content, 'html'))

# üîπ G·ª≠i email qua SMTP (Gmail SMTP Server)
try:
    server = smtplib.SMTP("smtp.gmail.com", 587)
    server.starttls()
    server.login(EMAIL_SENDER, EMAIL_PASSWORD)
    server.sendmail(EMAIL_SENDER, EMAIL_RECEIVER, msg.as_string())
    server.quit()
    print("‚úÖ Email ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!")
except Exception as e:
    print("‚ùå L·ªói khi g·ª≠i email:", str(e))

