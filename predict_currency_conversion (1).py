# -*- coding: utf-8 -*-
"""predict currency conversion

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1iGmqSxYIqzQQsq8HSvbbOaduYURhmeTP
"""

import streamlit as st
import pandas as pd

# Táº£i file lÃªn Streamlit
uploaded_file = st.file_uploader("Data system POC_11Nov2024(mod).xlsx", type=["xlsx", "xls"])

if uploaded_file is not None:
    # Äá»c file Excel
    df_ref = pd.read_excel(uploaded_file, sheet_name="Data- refinitiv")
    df1 = pd.read_excel(uploaded_file, sheet_name="Sheet2")

    # Hiá»ƒn thá»‹ dataframe
    st.write(df)

df.isna().sum()

df.duplicated()

df=df.fillna(method='ffill')

df.tail(10)

plt.plot(df['Date'],df['VND'])
plt.xlabel('Date')
plt.ylabel('VND= (BID)')
plt.title('changing of currency conversion after years')
plt.show()

plt.plot(df['Date'],df['FEDRATE'])
plt.xlabel('Date')
plt.ylabel('FED RATE')
plt.title('FED RATE changes after years')
plt.show()

plt.plot(df['Date'],df['DXY'])
plt.xlabel('Date')
plt.ylabel('DXY')
plt.title('DXY changes after years')
plt.show()

plt.plot(df['Date'],df['OMOrate'])
plt.xlabel('Date')
plt.ylabel('OMO rate')
plt.title('OMO rate changes after years')
plt.figure(figsize=(40,4))
plt.show()

plt.plot(df['Date'],df['SBVcentralrate'])
plt.xlabel('Date')
plt.ylabel('SBV central rate')
plt.title('SBV central rate change after years')
plt.figure(figsize=(40,4))
plt.show()

name=input("Má»i nháº­p tÃªn chá»‰ sá»‘ muá»‘n xem dá»¯ liá»‡u lá»‹ch sá»­:(FEDRATE,DXY,VND,OMOrate,SBVcentralrate)")
n=int(input("Má»i nháº­p sá»‘ ngÃ y muá»‘n xem:"))
file_path = "/content/Data system POC_11Nov2024(mod).xlsx"
df = pd.read_excel(file_path, sheet_name=None)  # Äá»c táº¥t cáº£ sheet
df_ref = df["Data- refinitiv"]
if name== 'FEDRATE' :
    print(df_ref['Date'].iloc[:n],df_ref['FEDRATE'].iloc[:n], sep='\n') # Print each value on a new line
elif name=='DXY' :
   print(df_ref['Date'].iloc[:n],df_ref['DXY'].iloc[:n], sep='\n') # Change here: Use df_ref to access the column
elif name=='VND' :
   print(df_ref['Date'].iloc[:n],df_ref['VND'].iloc[:n], sep='\n') # Change here: Use df_ref to access the column
elif name=='OMOrate' :
   print(df_ref['Date'].iloc[:n],df_ref['OMOrate'].iloc[:n], sep='\n') # Change here: Use df_ref to access the column
elif name=='SBVcentralrate' :
   print(df_ref['Date'].iloc[:n],df_ref['SBVcentralrate'].iloc[:n], sep='\n') # Change here: Use df_ref to access the column

def train_sarima(df_ref, n):

    # Äáº£m báº£o dá»¯ liá»‡u sáº¯p xáº¿p theo ngÃ y
    train_values = df_ref["VND"].dropna().astype(float).sort_index()
    history = list(train_values)

    predictions = []
    labels = []
    percent_changes = []

    for _ in range(n):
        model = SARIMAX(history, order=(2,1,0))
        model_fit = model.fit(disp=False)

        forecast = model_fit.forecast(steps=1)[0]
        prev_value = history[-1]

        trend = "Up" if forecast > prev_value else "Down"
        labels.append(trend)

        percent_change = ((forecast - prev_value) / prev_value * 100) if prev_value != 0 else 0
        percent_changes.append(percent_change)

        history.append(forecast)
        predictions.append(forecast)

    return predictions, labels, percent_changes

# Äá»c dá»¯ liá»‡u tá»« file Excel (chá»‰ Ä‘á»c 1 láº§n)

df_ref["Date"] = pd.to_datetime(df_ref["Date"])
df_ref.set_index("Date", inplace=True)

df1["Date"] = pd.to_datetime(df1["Date"])
df1.set_index("Date", inplace=True)

# NgÆ°á»i dÃ¹ng nháº­p sá»‘ ngÃ y cáº§n dá»± bÃ¡o
n = int(input("Nháº­p sá»‘ ngÃ y cáº§n dá»± bÃ¡o: "))

# Cháº¡y mÃ´ hÃ¬nh SARIMA
predictions, labels, percent_changes = train_sarima(df_ref, n)

# Xuáº¥t káº¿t quáº£
print("\nğŸ“Š **Dá»± bÃ¡o giÃ¡ trá»‹ VND:**", predictions)
print("\nğŸ“ˆ **Xu hÆ°á»›ng biáº¿n Ä‘á»™ng:**", labels)
print("\nğŸ“‰ **Tá»· lá»‡ thay Ä‘á»•i (%):**", percent_changes)

# Láº¥y giÃ¡ trá»‹ thá»±c táº¿ Ä‘á»ƒ so sÃ¡nh
df1["VND"] = df1["VND"].apply(lambda x: float(str(x).replace("\xa0", "")))
Y_TRUE = df1["VND"].iloc[:n].tolist()
print("\n**GiÃ¡ trá»‹ thá»±c táº¿:**", Y_TRUE)
# XÃ¡c Ä‘á»‹nh ngÃ y báº¯t Ä‘áº§u dá»± bÃ¡o
last_date = df_ref.index[0]  # NgÃ y cuá»‘i cá»§a táº­p dá»¯ liá»‡u huáº¥n luyá»‡n
forecast_dates = pd.date_range(start=last_date, periods=n+1, freq='D')[1:]

# **Váº¼ BIá»‚U Äá»’ GIÃ Lá»ŠCH Sá»¬ + Dá»° BÃO + GIÃ THáº¬T**
plt.figure(figsize=(14, 6))

#  **Váº½ Ä‘Æ°á»ng giÃ¡ dá»± bÃ¡o**
plt.plot(forecast_dates, predictions, color='black', linestyle='-', marker='o', label="Dá»± bÃ¡o")

# **Váº½ Ä‘Æ°á»ng giÃ¡ tháº­t**
plt.plot(forecast_dates, Y_TRUE, color='red', linestyle='--', marker='x', label="GiÃ¡ tháº­t")

plt.xlabel("NgÃ y")
plt.ylabel("GiÃ¡ VND")
plt.title("Biá»ƒu Ä‘á»“ giÃ¡ VND - Lá»‹ch sá»­ vs Dá»± bÃ¡o vs Thá»±c táº¿")
plt.legend()
plt.grid(True)
plt.show()

# ğŸ”¹ Nháº­p email ngÆ°á»i nháº­n
EMAIL_RECEIVER = input('Má»i báº¡n nháº­p vÃ o email ngÆ°á»i nháº­n: ')

# ğŸ”¹ Láº¥y máº­t kháº©u tá»« biáº¿n mÃ´i trÆ°á»ng (KhÃ´ng lÆ°u trá»±c tiáº¿p trong code)
EMAIL_SENDER = "namltmta@gmail.com"
EMAIL_PASSWORD = "jlxk sqlk gckc eqzz"

# ğŸ”¹ Giáº£ láº­p dá»± bÃ¡o tá»· giÃ¡ (dá»¯ liá»‡u máº«u)
forecast_dates = forecast_dates
predictions = predictions

# ğŸ”¹ Táº¡o ná»™i dung email
email_content = "<h2>Dá»± bÃ¡o tá»· giÃ¡ VND-USD tuáº§n tá»›i</h2><table border='1' cellpadding='5'>"
email_content += "<tr><th>NgÃ y</th><th>Dá»± Ä‘oÃ¡n giÃ¡</th></tr>"

for date, price in zip(forecast_dates, predictions):
    email_content += f"<tr><td>{date.strftime('%Y-%m-%d')}</td><td>{price:.2f} USD</td></tr>"

email_content += "</table>"

# ğŸ”¹ Thiáº¿t láº­p email
msg = MIMEMultipart()
msg['From'] = EMAIL_SENDER
msg['To'] = EMAIL_RECEIVER
msg['Subject'] = "BÃ¡o cÃ¡o dá»± bÃ¡o tá»· giÃ¡ VND-USD tuáº§n tá»›i"
msg.attach(MIMEText(email_content, 'html'))

# ğŸ”¹ Gá»­i email qua SMTP (Gmail SMTP Server)
try:
    server = smtplib.SMTP("smtp.gmail.com", 587)
    server.starttls()
    server.login(EMAIL_SENDER, EMAIL_PASSWORD)
    server.sendmail(EMAIL_SENDER, EMAIL_RECEIVER, msg.as_string())
    server.quit()
    print("âœ… Email Ä‘Ã£ Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng!")
except Exception as e:
    print("âŒ Lá»—i khi gá»­i email:", str(e))

















